name: Fly Deploy

on:
    push:
        branches: [main]
        paths:
            - "app/**"
            - ".github/workflows/fly-deploy.yml"
    workflow_dispatch: # Allow manual deploys from the Actions tab

concurrency:
    group: fly-deploy
    cancel-in-progress: true

jobs:
    deploy:
        name: Deploy to Fly.io
        runs-on: ubuntu-latest
        defaults:
            run:
                working-directory: app
        environment:
            name: production
            url: https://${{ secrets.FLY_APP_NAME }}.fly.dev

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Set up flyctl
              uses: superfly/flyctl-actions/setup-flyctl@master

            - name: Deploy to Fly.io
              run: flyctl deploy --remote-only --wait-timeout 300
              env:
                  FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}

            - name: Verify deployment health
              run: |
                  echo "Waiting for deployment to stabilize..."
                  sleep 10
                  STATUS=$(flyctl status --json | python3 -c "import sys,json; d=json.load(sys.stdin); print(d.get('Status','unknown'))")
                  echo "App status: $STATUS"
                  HEALTH=$(curl -sf "https://${{ secrets.FLY_APP_NAME }}.fly.dev/health" || echo '{"status":"unreachable"}')
                  echo "Health check: $HEALTH"
              env:
                  FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}

            - name: Post failure notice
              if: failure()
              run: echo "::error::Deployment failed. Check Fly.io dashboard at https://fly.io/apps/${{ secrets.FLY_APP_NAME }}"
